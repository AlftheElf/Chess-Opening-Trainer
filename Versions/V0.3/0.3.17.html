<!-- Version 0.3.17 -->     
<!-- 

The Version in which I add the html for the spans and buttons and things so I can learn how I can wait for a response.

TODO:

- Add the name and questions
- Do the master function
- Continue copying from python
- Eventually get the svg for checked kings (or learn how to add a red background).


Discoveries: 

Once you get checkmate, the page stops.
The order is like we run through the script so that the "board" is loaded with getElementFromID and things.
Then the function keeps running because it's set up like a loop, but once checkmate is reached it halts.

You only change the bottom bit with the "const board" to change the style and flip the board. 

You can edit const chess = new Chess("r1bqkb1r/ppp2ppp/2n2n2/3pp3/3PP3/2N2N2/PPP2PPP/R1BQKB1R w KQkq - 4 5") to start at a specific FEN

The code that draws the board calls the line board.enableMoveInput(inputHandler, COLOR.white); this is what calls the main game function. I believe we never leave the event handler afterthis.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess Opening Trainer</title>
    <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1.0"/>
    <link rel="stylesheet" href="/cm-chessboard/styles/cm-chessboard.css"/> 
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style type="text/css">

        body{font-family: 'Montserrat', sans-serif;}

        /*#board{
            width: 800px; 
            max-width: 800px;
        }*/
        
/*        #interface{
            width: 200px;
            height: 100%;
            border-style: solid;
        }*/

        .grid-container {
        display: grid;
        grid-template-columns: 1fr 0.6fr;
        grid-template-rows: 1fr;
        gap: 0px 0px;
        }

        .board {
            grid-area: 1 / 1 / 2 / 3;
            width: 800px;
            max-width: 800px;
        }
        #interface { 
            grid-area: 1 / 2 / 2 / 3; 
            border-style: solid;
            border-width: thin;
            width: 400px;
            max-width: 400px;
        }

        p{
            width: 100%;
            align: center;
        }

    </style>
</head>
<body>


<div class="grid-container">
  <div class="board" id="board"></div>
  <div id="interface">
      <span id="prompt"></span>
      <br><br>
      <input type="button" id="button" onclick="buttonclick()" value="Continue">
  </div>
</div>


<script type="text/javascript">


//SETTINGS

var rating = '1600';
var realistic = true; 

//define functions

function c(input){
    console.log(input)
}


var clicked = false;
function buttonclick(){
    printWalrus()
}

function getJSON(FEN, type, rating=null) {

    if (type == 'lichess'){
        url = `https://explorer.lichess.ovh/lichess?topGames=0&moves=100&variant=standard&speeds[]=classical&ratings[]=${rating}&fen=${FEN.replaceAll(' ','%20')}`
    }
    if (type == 'master'){
        url = `https://explorer.lichess.ovh/master?topGames=0&moves=100&fen=${FEN.replaceAll(' ','%20')}`
    }

    var jqXHR = $.ajax({
        url: url,
        dataType: 'json',
        async: false,
        //success: function (data) {
        //    callBack(data);}
    });
    //console.log(url)
    return jqXHR.responseJSON;
}





// This is how we keypress!

var addEvent = document.addEventListener ? function(target,type,action){
    if(target){
        target.addEventListener(type,action,false);
    }
} : function(target,type,action){
    if(target){
        target.attachEvent('on' + type,action,false);
    }
}

addEvent(document,'keydown',function(e){
    e = e || window.event;
    var key = e.which || e.keyCode;
    if(key===13){
        showAnswer();
    }
});


function showAnswer(){
    document.getElementById("prompt").innerHTML = "The answer is e5"
    clicked = true;
}


function getOpponentMove(FEN){
        var data = getJSON(FEN,'lichess',rating);

        //add totals to object
        for (var i = 0; i < data.moves.length; i++) {
            data.moves[i].total = data.moves[i].white +  data.moves[i].draws + data.moves[i].black; 
        }

        //console.log('data', data)

        var possibleMoves = [];

        var i;
        for (i = 0; i < data.moves.length; i++) {
            if (data.moves[i].total > 100){
                possibleMoves.push(data.moves[i]);
            }
        }
        
        // Roll to select a move

        if(realistic == true){

            return chooseWeightedRandomMove(possibleMoves)
            console.log("possibleMoves", possibleMoves)

        }else{

            //Do a non-weighted random choice.

        }
}

function weighted_random(items, weights) {
    var i;

    for (i = 0; i < weights.length; i++)
        weights[i] += weights[i - 1] || 0;
    
    var random = Math.random() * weights[weights.length - 1];
    
    for (i = 0; i < weights.length; i++)
        if (weights[i] > random)
            break;
    
    return items[i];
}

function chooseWeightedRandomMove(possibleMoves){ 

    weights = [];

    var i;
    for (i = 0; i < possibleMoves.length; i++){
        weights.push(possibleMoves[i].total);
    }

    return weighted_random(possibleMoves, weights)

}

function getOpeningName(){

}



</script>

<script type="module">

    var DATA;

    var side = 'black' //select which side to play as


    
    import {INPUT_EVENT_TYPE, COLOR, Chessboard, MARKER_TYPE} from "/cm-chessboard/src/cm-chessboard/Chessboard.js"
    import {BORDER_TYPE} from "/cm-chessboard/src/cm-chessboard/Chessboard.js"


    const chess = new Chess() //Creates a new Chess() object. Add a FEN string as an argument to start from a FEN.

    function inputHandler(event) {
        console.log("event", event)
        event.chessboard.removeMarkers(undefined, MARKER_TYPE.dot)


        //Before move. Clicking about, and showing dot for possible moves and such.
        if (event.type === INPUT_EVENT_TYPE.moveStart) {
            const moves = chess.moves({square: event.square, verbose: true});
            for (const move of moves) {
                event.chessboard.addMarker(move.to, MARKER_TYPE.dot)
            }
            return moves.length > 0

        //Here is once a move has been attempted    
        } else if (event.type === INPUT_EVENT_TYPE.moveDone) {
            const move = {from: event.squareFrom, to: event.squareTo} //gets which move was attempted from event
            const result = chess.move(move) //gets result of move
            

            //Makes moves for the player
            if (result && clicked == true) { //if result is anyting then we processed
                event.chessboard.disableMoveInput()
                event.chessboard.setPosition(chess.fen())

                document.getElementById("prompt").innerHTML = "";

                //Makes moves for the computer
                const possibleMoves = chess.moves({verbose: true})
                if (possibleMoves.length > 0) {
                    const randomIndex = Math.floor(Math.random() * possibleMoves.length)
                    const randomMove = possibleMoves[randomIndex]
                    setTimeout(() => { // smoother with 500ms delay
                        chess.move({from: randomMove.from, to: randomMove.to})
                        if(side === 'white') {
                            event.chessboard.enableMoveInput(inputHandler, COLOR.white)
                        }
                        else {
                            event.chessboard.enableMoveInput(inputHandler, COLOR.black)
                        }
                        event.chessboard.setPosition(chess.fen())
                    }, 500)
                }
            } else { //If result returns null, then we will loop back to the begining of the function to have another go with new dots.
                console.warn("invalid move", move)
            }
            return result
        }
    }


    if (side == 'white'){
        const board = new Chessboard(document.getElementById("board"), {
            position: chess.fen(),
            sprite: {url: "/cm-chessboard/assets/images/chessboard-sprite-staunty.svg"},
            style: {moveMarker: MARKER_TYPE.square, hoverMarker: undefined},
            orientation: COLOR.white
        })
        board.enableMoveInput(inputHandler, COLOR.white)
    }
    else{
        const board = new Chessboard(document.getElementById("board"), {
            position: chess.fen(),
            sprite: {url: "/cm-chessboard/assets/images/chessboard-sprite-staunty.svg"},
            style: {moveMarker: MARKER_TYPE.square, hoverMarker: undefined},
            orientation: COLOR.black
        })

        var nextMove = getOpponentMove(chess.fen());

        console.log('chess_before' , chess)
        console.log('board_before' , board)
        console.log('FEN A', chess.fen())

        var boardTest;

        setTimeout(() => { // smoother with 500ms delay
            chess.move({from: nextMove.uci.slice(0,2), to: nextMove.uci.slice(2,4)})
            board.enableMoveInput(inputHandler, COLOR.black)
            board.setPosition(chess.fen())
            console.log('FEN E', chess.fen())

            //A timeout function waits 500 seconds to do what's in here, that's why setPosition happens so late.

            document.getElementById("prompt").innerHTML = "What position is this?"

        }, 500)

        console.log('chess_after' , chess)
        console.log('board_after' , board)
        console.log('FEN B', chess.fen())

        console.log('nextMove', nextMove)
    }

</script>
</body>
</html>