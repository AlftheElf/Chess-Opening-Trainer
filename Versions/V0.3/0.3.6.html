<!-- Version 0.3.6 -->
<!-- 

The Version in which I try the custom event!

TODO:

-   Fix the fact that we require an event for the first move to work it should happen automatically. Maybe try to get the oneTimeBool outside the event function.
-   Combine the white function with the black function for a more elegant function


Discoveries: 

Once you get checkmate, the page stops.
The order is like we run through the script so that the "board" is loaded with getElementFromID and things.
Then the function keeps running because it's set up like a loop, but once checkmate is reached it halts.

You only change the bottom bit with the "const board" to change the style and flip the board. 

You can edit const chess = new Chess("r1bqkb1r/ppp2ppp/2n2n2/3pp3/3PP3/2N2N2/PPP2PPP/R1BQKB1R w KQkq - 4 5") to start at a specific FEN

The code that draws the board calls the line board.enableMoveInput(inputHandler, COLOR.white); this is what calls the main game function. I believe we never leave the event handler afterthis.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess Opening Trainer</title>
    <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1.0"/>
    <link rel="stylesheet" href="/cm-chessboard/styles/cm-chessboard.css"/> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>

<div class="board" id="board" style="width: 800px; max-width: 800px"></div>

<div id="output"></div>


<script type="text/javascript">

//define functions

function c(input){
    console.log(input)
}

function getMoves(FEN, type, rating=null){

    if (type == 'lichess'){
        url = `https://explorer.lichess.ovh/lichess?topGames=0&moves=100&variant=standard&speeds[]=classical&ratings[]=${rating}&fen=${FEN.replaceAll(' ','%20')}`
    }
    if (type == 'master'){
        url = `https://explorer.lichess.ovh/master?topGames=0&moves=100&fen=${FEN.replaceAll(' ','%20')}`
    }

    $.getJSON(url, callback);

    function callback(data){
        var result = data
        //console.log(result)
    }
}

getMoves("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1", 'master')


</script>


<script type="module">

    //This is a naive flip but we still play as white, I now need to work out how to actually play as black.

    var side = 'black'

    
    import {INPUT_EVENT_TYPE, COLOR, Chessboard, MARKER_TYPE} from "/cm-chessboard/src/cm-chessboard/Chessboard.js"
    import {BORDER_TYPE} from "/cm-chessboard/src/cm-chessboard/Chessboard.js"


    const chess = new Chess() //Creates a new Chess() object. Add a FEN string as an argument to start from a FEN.

    //console.log("chess", chess)

    //            console.log(chess.fen())
    //            event.chessboard.setPosition('r1bqk1nr/pp3ppp/n1p1p3/4b3/PPPpPPPP/3P4/8/RNBQKBNR b KQkq - 0 8')


    // function inputHandler(event) { //This is the game loop essentially
    //     console.log("event", event)
    //     event.chessboard.removeMarkers(undefined, MARKER_TYPE.dot)

    //     //Before move. Clicking about, and showing dot for possible moves and such.
    //     if (event.type === INPUT_EVENT_TYPE.moveStart) {
    //         const moves = chess.moves({square: event.square, verbose: true});
    //         for (const move of moves) {
    //             event.chessboard.addMarker(move.to, MARKER_TYPE.dot)
    //         }
    //         return moves.length > 0

    //     //Here is once a move has been attempted    
    //     } else if (event.type === INPUT_EVENT_TYPE.moveDone) {
    //         const move = {from: event.squareFrom, to: event.squareTo} //gets which move was attempted from event
    //         const result = chess.move(move) //gets result of move
            
    //         if (result) { //if result is anyting then we processed
    //             event.chessboard.disableMoveInput()
    //             event.chessboard.setPosition(chess.fen())
    //             const possibleMoves = chess.moves({verbose: true})
    //             if (possibleMoves.length > 0) {
    //                 const randomIndex = Math.floor(Math.random() * possibleMoves.length)
    //                 const randomMove = possibleMoves[randomIndex]
    //                 setTimeout(() => { // smoother with 500ms delay
    //                     chess.move({from: randomMove.from, to: randomMove.to})
    //                     event.chessboard.enableMoveInput(inputHandler, COLOR.white)
    //                     event.chessboard.setPosition(chess.fen())
    //                 }, 500)
    //             }
    //         } else { //If result returns null, then we will loop back to the begining of the function to have another go with new dots.
    //             console.warn("invalid move", move)
    //         }
    //         return result
    //     }
    // }


    //Black function

    //for move one, we only do it once, then we can loop, the same code as below. I'm actually doing this to see if there is anything which determines parity from the code, or whether white moves first just because chess.js says so.

    var oneTimeBool = true;

    //chess.move({})



    var board = null;

    //var chessFEN = "r1bqkb1r/ppp2ppp/2n2n2/3pp3/3PP3/2N2N2/PPP2PPP/R1BQKB1R w KQkq - 4 5"
    var chessFEN = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"

    // console.log("1:", chess.fen())
    // chess.fen() = "r1bqkb1r/ppp2ppp/2n2n2/3pp3/3PP3/2N2N2/PPP2PPP/R1BQKB1R w KQkq - 4 5"
    // console.log("2:", chess.fen())


    function inputHandler(event) { //This is the game loop essentially

        console.log("event", event)
        event.chessboard.removeMarkers(undefined, MARKER_TYPE.dot)

        //console.log("chess", chess)

        //console.log("board", board)

        //console.log("ChessFEN test: ", chess.fen() == chessFEN)

        //Do this only once
        if (oneTimeBool == true){
            event.chessboard.disableMoveInput()
            event.chessboard.setPosition(chess.fen())
            const possibleMoves = chess.moves({verbose: true})
                if (possibleMoves.length > 0) {
                    const randomIndex = Math.floor(Math.random() * possibleMoves.length)
                    const randomMove = possibleMoves[randomIndex]
                    setTimeout(() => { // smoother with 500ms delay
                        chess.move({from: randomMove.from, to: randomMove.to})
                        event.chessboard.enableMoveInput(inputHandler, COLOR.black)
                        event.chessboard.setPosition(chess.fen())
                    }, 500)
                }

            oneTimeBool = false;
        }


        //A test to see if we can set


        //Before move. Clicking about, and showing dot for possible moves and such.
        if (event.type === INPUT_EVENT_TYPE.moveStart) {
            const moves = chess.moves({square: event.square, verbose: true});
            for (const move of moves) {
                event.chessboard.addMarker(move.to, MARKER_TYPE.dot)
            }
            return moves.length > 0

        //Here is once a move has been attempted    
        } else if (event.type === INPUT_EVENT_TYPE.moveDone) {
            const move = {from: event.squareFrom, to: event.squareTo} //gets which move was attempted from event
            const result = chess.move(move) //gets result of move
            
            if (result) { //if result is anyting then we processed
                event.chessboard.disableMoveInput()
                event.chessboard.setPosition(chess.fen())
                const possibleMoves = chess.moves({verbose: true})
                if (possibleMoves.length > 0) {
                    const randomIndex = Math.floor(Math.random() * possibleMoves.length)
                    const randomMove = possibleMoves[randomIndex]
                    setTimeout(() => { // smoother with 500ms delay
                        chess.move({from: randomMove.from, to: randomMove.to})
                        event.chessboard.enableMoveInput(inputHandler, COLOR.black)
                        event.chessboard.setPosition(chess.fen())
                    }, 500)
                }
            } else { //If result returns null, then we will loop back to the begining of the function to have another go with new dots.
                console.warn("invalid move", move)
            }
            return result
        }
    }

    console.log('DRAWING')

    if (side == 'white'){
        const board = new Chessboard(document.getElementById("board"), {
            position: chess.fen(),
            sprite: {url: "/cm-chessboard/assets/images/chessboard-sprite-staunty.svg"},
            style: {moveMarker: MARKER_TYPE.square, hoverMarker: undefined},
            orientation: COLOR.white
        })
        board.enableMoveInput(inputHandler, COLOR.white)
        
    }else{
        //FENstring = chess.fen().replaceAll()
        const board = new Chessboard(document.getElementById("board"), {
            position: chess.fen(),
            sprite: {url: "/cm-chessboard/assets/images/chessboard-sprite-staunty.svg"},
            style: {moveMarker: MARKER_TYPE.square, hoverMarker: undefined},
            orientation: COLOR.black
        })
        board.enableMoveInput(inputHandler, COLOR.black)
        console.log(board)
    }

    function OnPrinterStateChanged(state) {
    var evt = new CustomEvent('printerstatechanged', { detail: state });

    window.dispatchEvent(evt);
}


//Listen to your custom event
window.addEventListener('printerstatechanged', function (e) {
    console.log('printer state changed', e.detail);
});



    // const board = new Chessboard(document.getElementById("board"), {
    // position: chess.fen(),
    // sprite: {url: "/cm-chessboard/assets/images/chessboard-sprite-staunty.svg"},
    // style: {moveMarker: MARKER_TYPE.square, hoverMarker: undefined},
    // orientation: COLOR.white
    // })



    //board.enableMoveInput(inputHandler, COLOR.white)

// I tested changing the style, and I do believe I should add settings menu to change the UI but for now I think the default is the best.

    // const board = new Chessboard(document.getElementById("board"), {
    //     position: chess.fen(),
    //     style: {
    //         borderType: BORDER_TYPE.frame
    //     },
    //     sprite: {url: "/cm-chessboard/assets/images/chessboard-sprite-staunty.svg"},
    //     orientation: COLOR.black
    // })


</script>


</body>
</html>